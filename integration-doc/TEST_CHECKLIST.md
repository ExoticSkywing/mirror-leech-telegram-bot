# Parse-Video 集成测试清单

## 🔍 测试前准备

### 环境检查
- [ ] Parse-Video服务运行正常 (端口18085)
- [ ] Mirror-Bot配置正确 (config.py)
- [ ] 所有新文件已创建
- [ ] handlers.py已正确修改
- [ ] 用户已授权 (在AUTHORIZED_CHATS中)

### 验证命令
```bash
# 检查Parse-Video服务
docker ps | grep parse-video
curl http://localhost:18085/

# 检查Mirror-Bot配置
cd /root/data/docker_data/mirror-leech-telegram-bot
grep "PARSE_VIDEO" config.py

# 检查新文件
ls -la bot/helper/parse_video_helper.py
ls -la bot/helper/ext_utils/url_utils.py
ls -la bot/modules/video_parser.py
ls -la bot/modules/direct_link_handler.py
```

---

## 🧪 功能测试

### 1. 基础功能测试

#### 1.1 Parse-Video API测试
```bash
# 测试API健康
curl http://localhost:18085/

# 测试视频解析
curl "http://localhost:18085/video/share/url/parse?url=https://v.kuaishou.com/xxx"
```
- [ ] API服务正常响应
- [ ] 返回正确的JSON格式
- [ ] code字段正确

#### 1.2 URL提取测试
- [ ] 能从纯文本中提取URL
- [ ] 能从带文字的消息中提取URL
- [ ] 空消息返回None
- [ ] 多个URL时返回第一个

---

### 2. Bot集成测试

#### 2.1 启动测试
```bash
# 启动Bot
cd /root/data/docker_data/mirror-leech-telegram-bot
python3 -m bot
```
- [ ] Bot启动无错误
- [ ] 没有导入错误
- [ ] 日志显示正常

#### 2.2 命令功能测试（确保不影响原有功能）
- [ ] `/start` 命令正常
- [ ] `/help` 命令正常
- [ ] `/ytdlleech <url>` 命令正常
- [ ] `/leech <url>` 命令正常
- [ ] 其他现有命令不受影响

---

### 3. Parse-Video功能测试

#### 3.1 快手视频测试
**测试链接:** (需要真实的快手分享链接)
```
用户发送: https://v.kuaishou.com/xxx
```

预期结果:
- [ ] Bot识别到链接
- [ ] 显示"检测到视频链接"
- [ ] 显示"正在通过Parse-Video解析..."
- [ ] 解析成功后显示标题和作者
- [ ] 开始下载视频
- [ ] 显示yt-dlp进度
- [ ] 上传到用户对话窗口
- [ ] 视频可以正常播放

#### 3.2 抖音视频测试
**测试链接:** (需要真实的抖音分享链接)
```
用户发送: https://v.douyin.com/xxx
```

预期结果:
- [ ] 识别并解析
- [ ] 下载无水印视频
- [ ] 上传成功

#### 3.3 小红书视频测试
**测试链接:** (需要真实的小红书分享链接)
```
用户发送: https://www.xiaohongshu.com/xxx
```

预期结果:
- [ ] 识别并解析
- [ ] 下载成功
- [ ] 上传成功

#### 3.4 图集测试（重要！）
**测试链接:** (需要真实的图集分享链接，如小红书图集)
```
用户发送: https://www.xiaohongshu.com/xxx (图集链接)
```

预期结果:
- [ ] 识别为图集
- [ ] 显示"类型: 图集"
- [ ] 显示图片数量
- [ ] 下载所有图片（进度显示）
- [ ] **以相册形式上传到TG**
- [ ] 第一张图片带Caption
- [ ] 其他图片不带Caption
- [ ] 可以滑动查看所有图片

#### 3.5 B站视频测试
**测试链接:**
```
用户发送: https://www.bilibili.com/video/BVxxx
```

预期结果:
- [ ] Parse-Video尝试解析
- [ ] 可能解析失败，降级到yt-dlp
- [ ] 最终下载成功

---

### 4. 降级策略测试

#### 4.1 YouTube链接测试（Parse-Video不支持）
**测试链接:**
```
用户发送: https://www.youtube.com/watch?v=xxx
```

预期结果:
- [ ] Parse-Video解析失败
- [ ] 显示"Parse-Video未能解析"
- [ ] 显示"尝试yt-dlp直接处理..."
- [ ] yt-dlp接管下载
- [ ] 下载成功

#### 4.2 无效链接测试
**测试链接:**
```
用户发送: https://invalid-site.com/video/123
```

预期结果:
- [ ] Parse-Video解析失败
- [ ] yt-dlp也失败
- [ ] 显示友好的错误消息
- [ ] 错误消息包含可能原因
- [ ] 显示原始链接

---

### 5. 边界情况测试

#### 5.1 无链接消息测试
**测试消息:**
```
用户发送: 你好
```

预期结果:
- [ ] 显示使用说明
- [ ] 列出支持的平台
- [ ] 提示可用命令
- [ ] 不触发下载

#### 5.2 长消息测试
**测试消息:**
```
用户发送: 这是一段很长的文字描述，中间包含一个链接 https://v.kuaishou.com/xxx 请帮我下载
```

预期结果:
- [ ] 正确提取URL
- [ ] 正常处理下载

#### 5.3 多个链接测试
**测试消息:**
```
用户发送: 链接1: https://v.kuaishou.com/xxx 链接2: https://v.douyin.com/yyy
```

预期结果:
- [ ] 处理第一个链接
- [ ] 忽略第二个链接

#### 5.4 已失效链接测试
**测试链接:** (故意使用已删除的视频链接)

预期结果:
- [ ] Parse-Video返回错误
- [ ] 显示友好的错误提示
- [ ] 提示可能已被删除

---

### 6. 权限测试

#### 6.1 授权用户测试
- [ ] 授权用户可以发送链接
- [ ] 功能正常工作

#### 6.2 未授权用户测试
- [ ] 未授权用户发送链接
- [ ] 显示"没有权限"
- [ ] 不执行下载

---

### 7. 性能测试

#### 7.1 响应速度测试
- [ ] API调用延迟 < 5秒
- [ ] 解析响应及时
- [ ] 进度更新流畅

#### 7.2 并发测试
- [ ] 多个用户同时发送链接
- [ ] 每个任务独立处理
- [ ] 无相互干扰

#### 7.3 大文件测试
- [ ] 能处理较大视频（>100MB）
- [ ] 进度显示正常
- [ ] 不会超时

---

### 8. 错误处理测试

#### 8.1 Parse-Video服务停止测试
```bash
# 停止Parse-Video服务
docker stop <parse-video-container-id>
```

预期结果:
- [ ] 健康检查失败
- [ ] 自动降级到yt-dlp
- [ ] 或显示服务不可用

#### 8.2 网络错误测试
- [ ] 超时处理正确
- [ ] 错误消息友好
- [ ] 不会崩溃

#### 8.3 下载中断测试
- [ ] 使用 `/cancel` 取消任务
- [ ] 清理临时文件
- [ ] 不影响其他任务

---

### 9. 日志检查

#### 9.1 正常日志
- [ ] Parse-Video API调用记录
- [ ] 解析成功/失败日志
- [ ] 下载进度日志
- [ ] 上传完成日志

#### 9.2 错误日志
- [ ] 错误堆栈完整
- [ ] 错误信息清晰
- [ ] 便于排查问题

---

### 10. 用户体验测试

#### 10.1 消息格式
- [ ] 状态消息格式美观
- [ ] HTML标签正确渲染
- [ ] Emoji显示正常

#### 10.2 Caption格式
- [ ] 包含配置的前缀
- [ ] 标题和作者信息完整
- [ ] 格式排版合理

#### 10.3 错误提示
- [ ] 错误信息通俗易懂
- [ ] 提供解决建议
- [ ] 不暴露技术细节

---

## 📊 测试记录表

| 测试项 | 状态 | 备注 | 测试时间 |
|--------|------|------|----------|
| Parse-Video服务 | ⏳ | | |
| API调用 | ⏳ | | |
| 快手视频 | ⏳ | | |
| 抖音视频 | ⏳ | | |
| 小红书图集 | ⏳ | | |
| YouTube降级 | ⏳ | | |
| 无效链接 | ⏳ | | |
| 权限控制 | ⏳ | | |
| 图集相册 | ⏳ | | |
| 错误处理 | ⏳ | | |

状态说明:
- ⏳ 待测试
- ✅ 通过
- ❌ 失败
- ⚠️ 部分通过

---

## 🐛 已知问题

记录测试中发现的问题：

### 问题1: [标题]
- **现象:** 
- **重现步骤:**
- **预期:**
- **实际:**
- **优先级:** 高/中/低
- **状态:** 待修复/已修复

---

## 🚀 优化建议

测试完成后的优化方向：

1. **性能优化**
   - [ ] 图片下载并发控制
   - [ ] 缓存机制
   - [ ] 重试策略

2. **功能增强**
   - [ ] 支持更多平台
   - [ ] 自定义下载质量
   - [ ] 批量链接处理

3. **用户体验**
   - [ ] 更详细的进度显示
   - [ ] 自定义Caption模板
   - [ ] 下载历史记录

---

## ✅ 测试完成标准

- [ ] 所有核心功能测试通过
- [ ] 无严重bug
- [ ] 错误处理完善
- [ ] 日志记录完整
- [ ] 用户体验良好
- [ ] 性能符合预期

---

**测试人员:** ___________
**测试日期:** ___________
**测试版本:** v1.0.0
**测试环境:** Production/Staging/Development

